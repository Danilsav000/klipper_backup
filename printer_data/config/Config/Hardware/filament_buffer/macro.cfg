

[gcode_macro Buffer_feeding]  ## Buffer feeding
gcode:
    {% set temp = printer["gcode_macro _USER_VARIABLES"].extruder_temp %}
    {% set length = printer["gcode_macro _USER_VARIABLES"].extruder_length %}
    {% set speed = printer["gcode_macro _USER_VARIABLES"].extruder_speed %}
    {% set time = printer["gcode_macro _USER_VARIABLES"].extruder_time %}
    {% set feedrate = speed * 60 %}

    RESPOND MSG="Heat the extruder to {temp} °C"
    M109 S{temp}

    RESPOND MSG="Start feeding {length}mm"
    SET_PIN PIN=_feeding VALUE=0
    G91  ; Relative coordinate mode
    G1 E{length} F{feedrate} 
    G90  ; Absolute coordinate mode
    G4 P{time *1000}

    RESPOND MSG="Extrusion completed"
    SET_PIN PIN=_feeding VALUE=1
    M104 S0

[gcode_macro Buffer_retracting]  ## Buffer retraction
gcode:
    {% set temp = printer["gcode_macro _USER_VARIABLES"].extruder_temp %}
    {% set length = printer["gcode_macro _USER_VARIABLES"].extruder_length %}
    {% set speed = printer["gcode_macro _USER_VARIABLES"].extruder_speed %}
    {% set time = printer["gcode_macro _USER_VARIABLES"].extruder_time %}
    {% set feedrate = speed * 60 %}

    RESPOND MSG="Heat the extruder to {temp} °C"
    M109 S{temp}

    RESPOND MSG="Start material return {length}mm"
    SET_PIN PIN=_material_return VALUE=0
    G91  ; Relative coordinate mode
    G1 E-{length} F{feedrate} 
    G90  ; Absolute coordinate mode
    G4 P{time *1000}

    RESPOND MSG="Return of materials completed"
    SET_PIN PIN=_material_return VALUE=1
    M104 S0